<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora Camerite - Franqueado</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .auth-container {
            max-width: 400px;
            margin: 100px auto;
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .auth-container h1 {
            text-align: center;
            color: #667eea;
            margin-bottom: 30px;
        }

        .auth-container input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }

        .auth-container button {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: none;
            border-radius: 8px;
            background: #667eea;
            color: white;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .auth-container button:hover {
            background: #5568d3;
        }

        .auth-container .error {
            color: #e74c3c;
            font-size: 14px;
            margin: 10px 0;
            text-align: center;
        }

        .auth-container .success {
            color: #27ae60;
            font-size: 14px;
            margin: 10px 0;
            text-align: center;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
            display: none;
        }

        .container.active {
            display: block;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .user-info {
            background: rgba(255,255,255,0.1);
            padding: 10px 20px;
            margin-top: 15px;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .user-info button {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .user-info button:hover {
            background: rgba(255,255,255,0.3);
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
            overflow-x: auto;
        }

        .tab {
            padding: 15px 25px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 16px;
            color: #6c757d;
            transition: all 0.3s;
            white-space: nowrap;
            border-bottom: 3px solid transparent;
        }

        .tab:hover {
            background: #e9ecef;
            color: #495057;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
            font-weight: 600;
        }

        .content {
            padding: 30px;
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card {
            background: #f8f9fa;
            padding: 25px;
            margin-bottom: 20px;
            border-radius: 12px;
            border-left: 4px solid #667eea;
        }

        .card h3 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.3em;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #495057;
            font-weight: 500;
        }

        input[type="number"],
        input[type="text"],
        select {
            width: 100%;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input[type="number"]:focus,
        input[type="text"]:focus,
        select:focus {
            outline: none;
            border-color: #667eea;
        }

        .radio-group {
            display: flex;
            gap: 20px;
            margin-top: 10px;
        }

        .radio-option {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .radio-option input[type="radio"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .result-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }

        .result-card h4 {
            color: #6c757d;
            font-size: 0.9em;
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        .result-card .value {
            font-size: 1.8em;
            font-weight: bold;
            color: #667eea;
        }

        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }

        th {
            background: #667eea;
            color: white;
            font-weight: 600;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .total-row {
            font-weight: bold;
            background: #e9ecef !important;
        }

        .positive {
            color: #28a745;
        }

        .negative {
            color: #dc3545;
        }

        .info-box {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            color: #0c5460;
        }

        .warning-box {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            color: #856404;
        }

        @media print {
            .no-print {
                display: none !important;
            }
            
            body {
                background: white;
            }
            
            .container {
                box-shadow: none;
                max-width: 100%;
            }
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }
            
            .tabs {
                flex-wrap: nowrap;
            }
            
            .tab {
                font-size: 14px;
                padding: 12px 15px;
            }
            
            .grid {
                grid-template-columns: 1fr;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            button {
                width: 100%;
            }
        }

        .collapsible {
            cursor: pointer;
            user-select: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .collapsible::after {
            content: '▼';
            font-size: 0.8em;
            transition: transform 0.3s;
        }

        .collapsible.collapsed::after {
            transform: rotate(-90deg);
        }

        .collapsible-content {
            max-height: 1000px;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .collapsible-content.collapsed {
            max-height: 0;
        }

        /* Estilos para tabelas horizontais (meses em colunas) */
        .table-horizontal-wrapper {
            overflow-x: auto;
            margin-top: 20px;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }

        .table-horizontal {
            min-width: 100%;
            border-collapse: collapse;
            background: white;
        }

        .table-horizontal th,
        .table-horizontal td {
            padding: 12px;
            text-align: right;
            border: 1px solid #dee2e6;
            white-space: nowrap;
        }

        .table-horizontal th:first-child,
        .table-horizontal td:first-child {
            text-align: left;
            position: sticky;
            left: 0;
            background: white;
            font-weight: 600;
            z-index: 1;
        }

        .table-horizontal th {
            background: #667eea;
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 2;
        }

        .table-horizontal th:first-child {
            background: #5568d3;
            z-index: 3;
        }

        .table-horizontal tr:hover td {
            background: #f8f9fa;
        }

        .table-horizontal tr:hover td:first-child {
            background: #f8f9fa;
        }

        .table-horizontal .total-row td {
            font-weight: bold;
            background: #e9ecef !important;
            border-top: 2px solid #667eea;
        }
    </style>
</head>
<body>
    <!-- Tela de Login -->
    <div id="authContainer" class="auth-container">
        <h1>🎥 Camerite</h1>
        <h3 style="text-align: center; color: #6c757d; margin-bottom: 30px;">Acesso Franqueados</h3>
        
        <div id="loginForm">
            <input type="email" id="loginEmail" placeholder="Email">
            <input type="password" id="loginPassword" placeholder="Senha">
            <button onclick="login()">Entrar</button>
            <p style="text-align: center; margin: 20px 0; color: #6c757d;">ou</p>
            <button onclick="showRegister()" style="background: #6c757d;">Criar Conta</button>
            <div id="authError" class="error"></div>
        </div>

        <div id="registerForm" style="display: none;">
            <input type="email" id="registerEmail" placeholder="Email">
            <input type="password" id="registerPassword" placeholder="Senha (mínimo 6 caracteres)">
            <input type="password" id="registerPasswordConfirm" placeholder="Confirme a senha">
            <button onclick="register()">Registrar</button>
            <button onclick="showLogin()" style="background: #6c757d;">Voltar ao Login</button>
            <div id="registerError" class="error"></div>
            <div id="registerSuccess" class="success"></div>
        </div>
    </div>

    <!-- Aplicação Principal -->
    <div class="container" id="mainContainer">
        <div class="header">
            <h1>🎥 Calculadora Camerite</h1>
            <p>Ferramenta de Simulação para Franqueados</p>
            <div class="user-info">
                <span id="userEmail"></span>
                <button onclick="logout()">Sair</button>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab(0)">1) Modelo</button>
            <button class="tab" onclick="switchTab(1)">2) Produtos</button>
            <button class="tab" onclick="switchTab(2)">3) Custos Fixos</button>
            <button class="tab" onclick="switchTab(3)">4) Equipamentos</button>
            <button class="tab" onclick="switchTab(4)">5) Implantação</button>
            <button class="tab" onclick="switchTab(5)">6) Simulação Mensal</button>
        </div>

        <div class="content">
            <!-- Tab 1: Modelo de Comercialização -->
            <div class="tab-content active">
                <div class="card">
                    <h3>Modelo de Comercialização</h3>
                    <div class="info-box">
                        <strong>Escolha o modelo:</strong>
                        <ul style="margin-top: 10px;">
                            <li><strong>Por Usuário:</strong> Preço fixo mensal por usuário do cliente</li>
                            <li><strong>Por Produto:</strong> Precificação individual de cada componente</li>
                        </ul>
                    </div>
                    <div class="form-group">
                        <label>Selecione o Modelo:</label>
                        <div class="radio-group">
                            <div class="radio-option">
                                <input type="radio" id="modeloUsuario" name="modelo" value="usuario" checked>
                                <label for="modeloUsuario">Por Usuário</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="modeloProduto" name="modelo" value="produto">
                                <label for="modeloProduto">Por Produto</label>
                            </div>
                        </div>
                    </div>
                    
                    <div id="modeloUsuarioConfig">
                        <div class="form-group">
                            <label>Valor por Usuário (R$/mês):</label>
                            <input type="number" id="valorUsuario" value="199" min="0" step="0.01">
                        </div>
                        <div class="form-group">
                            <label>Quantidade de Usuários:</label>
                            <input type="number" id="qtdUsuarios" value="10" min="1">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab 2: Produtos -->
            <div class="tab-content">
                <div class="card">
                    <h3>Configuração de Produtos</h3>
                    
                    <div id="produtosConfig">
                        <div class="warning-box">
                            <strong>Atenção:</strong> Configure os preços e quantidades de cada produto que será comercializado mensalmente.
                        </div>

                        <div class="grid">
                            <div class="form-group">
                                <label>Armazenamento (R$/unidade/mês):</label>
                                <input type="number" id="precoArmazenamento" value="50" min="0" step="0.01">
                            </div>
                            <div class="form-group">
                                <label>Quantidade Armazenamento:</label>
                                <input type="number" id="qtdArmazenamento" value="5" min="0">
                            </div>
                        </div>

                        <div class="grid">
                            <div class="form-group">
                                <label>PMI - Placa Mercosul (R$/unidade/mês):</label>
                                <input type="number" id="precoPMI" value="80" min="0" step="0.01">
                            </div>
                            <div class="form-group">
                                <label>Quantidade PMI:</label>
                                <input type="number" id="qtdPMI" value="3" min="0">
                            </div>
                        </div>

                        <div class="grid">
                            <div class="form-group">
                                <label>OCR - Reconhecimento (R$/unidade/mês):</label>
                                <input type="number" id="precoOCR" value="100" min="0" step="0.01">
                            </div>
                            <div class="form-group">
                                <label>Quantidade OCR:</label>
                                <input type="number" id="qtdOCR" value="2" min="0">
                            </div>
                        </div>

                        <div class="grid">
                            <div class="form-group">
                                <label>Toten (R$/unidade/mês):</label>
                                <input type="number" id="precoToten" value="150" min="0" step="0.01">
                            </div>
                            <div class="form-group">
                                <label>Quantidade Toten:</label>
                                <input type="number" id="qtdToten" value="1" min="0">
                            </div>
                        </div>

                        <div class="grid">
                            <div class="form-group">
                                <label>Detecções (R$/unidade/mês):</label>
                                <input type="number" id="precoDeteccoes" value="120" min="0" step="0.01">
                            </div>
                            <div class="form-group">
                                <label>Quantidade Detecções:</label>
                                <input type="number" id="qtdDeteccoes" value="2" min="0">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab 3: Custos Fixos -->
            <div class="tab-content">
                <div class="card">
                    <h3>Custos Fixos Mensais</h3>
                    
                    <div class="grid">
                        <div class="form-group">
                            <label>Internet (R$/mês):</label>
                            <input type="number" id="custoInternet" value="200" min="0" step="0.01">
                        </div>
                        <div class="form-group">
                            <label>Energia (R$/mês):</label>
                            <input type="number" id="custoEnergia" value="150" min="0" step="0.01">
                        </div>
                    </div>

                    <div class="grid">
                        <div class="form-group">
                            <label>Royalties Franquia (%):</label>
                            <input type="number" id="royalties" value="8" min="0" max="100" step="0.1">
                        </div>
                        <div class="form-group">
                            <label>Impostos sobre Receita (%):</label>
                            <input type="number" id="impostos" value="13.33" min="0" max="100" step="0.01">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Manutenção/Outros (R$/mês):</label>
                        <input type="number" id="custoManutencao" value="300" min="0" step="0.01">
                    </div>
                </div>

                <div class="card">
                    <h3>Custos Analíticos</h3>
                    <div class="info-box">
                        Custos repassados ao franqueado por uso de tecnologias específicas
                    </div>
                    
                    <div class="grid">
                        <div class="form-group">
                            <label>Custo OCR (R$/unidade/mês):</label>
                            <input type="number" id="custoOCR" value="30" min="0" step="0.01">
                        </div>
                        <div class="form-group">
                            <label>Custo Detecções (R$/unidade/mês):</label>
                            <input type="number" id="custoDeteccoes" value="25" min="0" step="0.01">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab 4: Equipamentos -->
            <div class="tab-content">
                <div class="card">
                    <h3>Câmeras LPR (Leitura de Placas)</h3>
                    
                    <div class="form-group">
                        <label>Modelo de Aquisição:</label>
                        <div class="radio-group">
                            <div class="radio-option">
                                <input type="radio" id="lprCompra" name="lprModelo" value="compra" checked>
                                <label for="lprCompra">Compra</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="lprLocacao" name="lprModelo" value="locacao">
                                <label for="lprLocacao">Locação</label>
                            </div>
                        </div>
                    </div>

                    <div class="grid">
                        <div class="form-group">
                            <label>Quantidade de Câmeras LPR:</label>
                            <input type="number" id="qtdLPR" value="4" min="0">
                        </div>
                        <div class="form-group" id="lprCompraValor">
                            <label>Valor de Compra (R$/unidade):</label>
                            <input type="number" id="valorCompraLPR" value="3500" min="0" step="0.01">
                        </div>
                        <div class="form-group" id="lprLocacaoValor" style="display: none;">
                            <label>Valor Locação (R$/unidade/mês):</label>
                            <input type="number" id="valorLocacaoLPR" value="300" min="0" step="0.01">
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3>Câmeras PMI (Placa Mercosul Infrações)</h3>
                    
                    <div class="form-group">
                        <label>Modelo de Aquisição:</label>
                        <div class="radio-group">
                            <div class="radio-option">
                                <input type="radio" id="pmiCompra" name="pmiModelo" value="compra" checked>
                                <label for="pmiCompra">Compra</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="pmiLocacao" name="pmiModelo" value="locacao">
                                <label for="pmiLocacao">Locação</label>
                            </div>
                        </div>
                    </div>

                    <div class="grid">
                        <div class="form-group">
                            <label>Quantidade de Câmeras PMI:</label>
                            <input type="number" id="qtdPMICam" value="3" min="0">
                        </div>
                        <div class="form-group" id="pmiCompraValor">
                            <label>Valor de Compra (R$/unidade):</label>
                            <input type="number" id="valorCompraPMI" value="4000" min="0" step="0.01">
                        </div>
                        <div class="form-group" id="pmiLocacaoValor" style="display: none;">
                            <label>Valor Locação (R$/unidade/mês):</label>
                            <input type="number" id="valorLocacaoPMI" value="350" min="0" step="0.01">
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3>Totens</h3>
                    
                    <div class="form-group">
                        <label>Modelo de Aquisição:</label>
                        <div class="radio-group">
                            <div class="radio-option">
                                <input type="radio" id="totenCompra" name="totenModelo" value="compra" checked>
                                <label for="totenCompra">Compra</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="totenLocacao" name="totenModelo" value="locacao">
                                <label for="totenLocacao">Locação</label>
                            </div>
                        </div>
                    </div>

                    <div class="grid">
                        <div class="form-group">
                            <label>Quantidade de Totens:</label>
                            <input type="number" id="qtdTotenEquip" value="1" min="0">
                        </div>
                        <div class="form-group" id="totenCompraValor">
                            <label>Valor de Compra (R$/unidade):</label>
                            <input type="number" id="valorCompraToten" value="8000" min="0" step="0.01">
                        </div>
                        <div class="form-group" id="totenLocacaoValor" style="display: none;">
                            <label>Valor Locação (R$/unidade/mês):</label>
                            <input type="number" id="valorLocacaoToten" value="600" min="0" step="0.01">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab 5: Implantação -->
            <div class="tab-content">
                <div class="card">
                    <h3>Custos de Implantação (Mês 0)</h3>
                    <div class="info-box">
                        Custos únicos cobrados do cliente no início do projeto
                    </div>
                    
                    <div class="grid">
                        <div class="form-group">
                            <label>Instalação (R$):</label>
                            <input type="number" id="custoInstalacao" value="5000" min="0" step="0.01">
                        </div>
                        <div class="form-group">
                            <label>Frete (R$):</label>
                            <input type="number" id="custoFrete" value="800" min="0" step="0.01">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Margem sobre Equipamentos (%):</label>
                        <input type="number" id="margemEquipamentos" value="30" min="0" max="100" step="0.1">
                        <small style="color: #6c757d; display: block; margin-top: 5px;">
                            Margem aplicada sobre o custo dos equipamentos vendidos
                        </small>
                    </div>
                </div>

                <div class="card">
                    <h3>Receita de Implantação</h3>
                    <div id="resumoImplantacao">
                        <!-- Será preenchido dinamicamente -->
                    </div>
                </div>
            </div>

            <!-- Tab 6: Simulação Mensal -->
            <div class="tab-content">
                <div class="card">
                    <h3>Dashboard</h3>
                    <div class="grid">
                        <div class="result-card">
                            <h4>Contrato Anual</h4>
                            <div class="value" id="contratoAnual">R$ 0,00</div>
                        </div>
                        <div class="result-card">
                            <h4>Receita Mensal</h4>
                            <div class="value" id="receitaMensal">R$ 0,00</div>
                        </div>
                        <div class="result-card">
                            <h4>Custo Mensal</h4>
                            <div class="value" id="custoMensal">R$ 0,00</div>
                        </div>
                        <div class="result-card">
                            <h4>Rentabilidade Mensal</h4>
                            <div class="value" id="rentabilidade">0%</div>
                        </div>
                        <div class="result-card">
                            <h4>Mês de Equilíbrio</h4>
                            <div class="value" id="mesEquilibrio">-</div>
                        </div>
                        <div class="result-card">
                            <h4>Saldo Final (12 meses)</h4>
                            <div class="value" id="saldoFinal">R$ 0,00</div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3 class="collapsible" onclick="toggleCollapse('despesasContent')">Despesas por Mês</h3>
                    <div id="despesasContent" class="collapsible-content">
                        <div id="tabelaDespesas"></div>
                    </div>
                </div>

                <div class="card">
                    <h3 class="collapsible" onclick="toggleCollapse('receitasContent')">Receitas por Mês</h3>
                    <div id="receitasContent" class="collapsible-content">
                        <div id="tabelaReceitas"></div>
                    </div>
                </div>

                <div class="card">
                    <h3 class="collapsible" onclick="toggleCollapse('saldoContent')">Saldo por Mês</h3>
                    <div id="saldoContent" class="collapsible-content">
                        <div id="tabelaSaldo"></div>
                    </div>
                </div>

                <div class="button-group no-print">
                    <button class="btn-primary" onclick="calcular()">🔄 Recalcular</button>
                    <button class="btn-primary" onclick="exportarPDF()">📄 Exportar PDF</button>
                    <button class="btn-secondary" onclick="limparDados()">🗑️ Limpar Dados</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuração Supabase
        const SUPABASE_URL = 'https://kkydtsofzwkrzpwcwhqs.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtreWR0c29mendrcnpwd2N3aHFzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzgxMzEwODksImV4cCI6MjA1MzcwNzA4OX0.6_mF62bAjQgdXBxW6KjO8Iut9bDKRmQaAVcJIz2GGss';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // Gerenciamento de Estado
        let currentUser = null;

        // Verificar sessão ao carregar
        async function checkSession() {
            const { data: { session } } = await supabase.auth.getSession();
            if (session) {
                currentUser = session.user;
                showApp();
            }
        }

        // Login
        async function login() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const errorDiv = document.getElementById('authError');

            try {
                const { data, error } = await supabase.auth.signInWithPassword({
                    email: email,
                    password: password
                });

                if (error) throw error;

                currentUser = data.user;
                showApp();
            } catch (error) {
                errorDiv.textContent = 'Erro no login: ' + error.message;
            }
        }

        // Registro
        async function register() {
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const passwordConfirm = document.getElementById('registerPasswordConfirm').value;
            const errorDiv = document.getElementById('registerError');
            const successDiv = document.getElementById('registerSuccess');

            errorDiv.textContent = '';
            successDiv.textContent = '';

            if (password !== passwordConfirm) {
                errorDiv.textContent = 'As senhas não coincidem';
                return;
            }

            if (password.length < 6) {
                errorDiv.textContent = 'A senha deve ter pelo menos 6 caracteres';
                return;
            }

            try {
                const { data, error } = await supabase.auth.signUp({
                    email: email,
                    password: password
                });

                if (error) throw error;

                successDiv.textContent = 'Conta criada com sucesso! Verifique seu email para confirmar.';
                setTimeout(() => showLogin(), 3000);
            } catch (error) {
                errorDiv.textContent = 'Erro no registro: ' + error.message;
            }
        }

        // Logout
        async function logout() {
            await supabase.auth.signOut();
            currentUser = null;
            document.getElementById('authContainer').style.display = 'block';
            document.getElementById('mainContainer').classList.remove('active');
        }

        // Mostrar app
        function showApp() {
            document.getElementById('authContainer').style.display = 'none';
            document.getElementById('mainContainer').classList.add('active');
            document.getElementById('userEmail').textContent = currentUser.email;
            carregarDados();
            calcular();
        }

        // Alternar telas de auth
        function showLogin() {
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('registerForm').style.display = 'none';
        }

        function showRegister() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('registerForm').style.display = 'block';
        }

        // Inicializar
        checkSession();

        // Alternar entre modelos
        document.querySelectorAll('input[name="modelo"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const isUsuario = this.value === 'usuario';
                document.getElementById('modeloUsuarioConfig').style.display = isUsuario ? 'block' : 'none';
                document.getElementById('produtosConfig').style.display = isUsuario ? 'none' : 'block';
                calcular();
            });
        });

        // Alternar modelo LPR
        document.querySelectorAll('input[name="lprModelo"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const isCompra = this.value === 'compra';
                document.getElementById('lprCompraValor').style.display = isCompra ? 'block' : 'none';
                document.getElementById('lprLocacaoValor').style.display = isCompra ? 'none' : 'block';
                calcular();
            });
        });

        // Alternar modelo PMI
        document.querySelectorAll('input[name="pmiModelo"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const isCompra = this.value === 'compra';
                document.getElementById('pmiCompraValor').style.display = isCompra ? 'block' : 'none';
                document.getElementById('pmiLocacaoValor').style.display = isCompra ? 'none' : 'block';
                calcular();
            });
        });

        // Alternar modelo Toten
        document.querySelectorAll('input[name="totenModelo"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const isCompra = this.value === 'compra';
                document.getElementById('totenCompraValor').style.display = isCompra ? 'block' : 'none';
                document.getElementById('totenLocacaoValor').style.display = isCompra ? 'none' : 'block';
                calcular();
            });
        });

        // Função para alternar abas
        function switchTab(index) {
            const tabs = document.querySelectorAll('.tab');
            const contents = document.querySelectorAll('.tab-content');
            
            tabs.forEach(tab => tab.classList.remove('active'));
            contents.forEach(content => content.classList.remove('active'));
            
            tabs[index].classList.add('active');
            contents[index].classList.add('active');
            
            if (index === 5) {
                calcular();
            }
        }

        // Função para colapsar/expandir seções
        function toggleCollapse(contentId) {
            const content = document.getElementById(contentId);
            const header = content.previousElementSibling;
            
            content.classList.toggle('collapsed');
            header.classList.toggle('collapsed');
        }

        // Função principal de cálculo
        function calcular() {
            const modelo = document.querySelector('input[name="modelo"]:checked').value;
            
            // Calcular receita mensal
            let receitaMensal = 0;
            if (modelo === 'usuario') {
                const valorUsuario = parseFloat(document.getElementById('valorUsuario').value) || 0;
                const qtdUsuarios = parseInt(document.getElementById('qtdUsuarios').value) || 0;
                receitaMensal = valorUsuario * qtdUsuarios;
            } else {
                const precoArm = parseFloat(document.getElementById('precoArmazenamento').value) || 0;
                const qtdArm = parseInt(document.getElementById('qtdArmazenamento').value) || 0;
                const precoPMI = parseFloat(document.getElementById('precoPMI').value) || 0;
                const qtdPMI = parseInt(document.getElementById('qtdPMI').value) || 0;
                const precoOCR = parseFloat(document.getElementById('precoOCR').value) || 0;
                const qtdOCR = parseInt(document.getElementById('qtdOCR').value) || 0;
                const precoToten = parseFloat(document.getElementById('precoToten').value) || 0;
                const qtdToten = parseInt(document.getElementById('qtdToten').value) || 0;
                const precoDeteccoes = parseFloat(document.getElementById('precoDeteccoes').value) || 0;
                const qtdDeteccoes = parseInt(document.getElementById('qtdDeteccoes').value) || 0;
                
                receitaMensal = (precoArm * qtdArm) + (precoPMI * qtdPMI) + (precoOCR * qtdOCR) + 
                               (precoToten * qtdToten) + (precoDeteccoes * qtdDeteccoes);
            }
            
            // Custos fixos mensais
            const custoInternet = parseFloat(document.getElementById('custoInternet').value) || 0;
            const custoEnergia = parseFloat(document.getElementById('custoEnergia').value) || 0;
            const custoManutencao = parseFloat(document.getElementById('custoManutencao').value) || 0;
            const royalties = (parseFloat(document.getElementById('royalties').value) || 0) / 100;
            const impostos = (parseFloat(document.getElementById('impostos').value) || 0) / 100;
            
            // Custos analíticos
            const custoOCR = parseFloat(document.getElementById('custoOCR').value) || 0;
            const qtdOCRProd = parseInt(document.getElementById('qtdOCR').value) || 0;
            const custoDeteccoes = parseFloat(document.getElementById('custoDeteccoes').value) || 0;
            const qtdDeteccoesProd = parseInt(document.getElementById('qtdDeteccoes').value) || 0;
            
            const custoAnalitico = (custoOCR * qtdOCRProd) + (custoDeteccoes * qtdDeteccoesProd);
            
            // Equipamentos - Locação mensal
            const lprModelo = document.querySelector('input[name="lprModelo"]:checked').value;
            const pmiModelo = document.querySelector('input[name="pmiModelo"]:checked').value;
            const totenModelo = document.querySelector('input[name="totenModelo"]:checked').value;
            
            let custoLocacaoMensal = 0;
            
            if (lprModelo === 'locacao') {
                const valorLocacaoLPR = parseFloat(document.getElementById('valorLocacaoLPR').value) || 0;
                const qtdLPR = parseInt(document.getElementById('qtdLPR').value) || 0;
                custoLocacaoMensal += valorLocacaoLPR * qtdLPR;
            }
            
            if (pmiModelo === 'locacao') {
                const valorLocacaoPMI = parseFloat(document.getElementById('valorLocacaoPMI').value) || 0;
                const qtdPMICam = parseInt(document.getElementById('qtdPMICam').value) || 0;
                custoLocacaoMensal += valorLocacaoPMI * qtdPMICam;
            }
            
            if (totenModelo === 'locacao') {
                const valorLocacaoToten = parseFloat(document.getElementById('valorLocacaoToten').value) || 0;
                const qtdTotenEquip = parseInt(document.getElementById('qtdTotenEquip').value) || 0;
                custoLocacaoMensal += valorLocacaoToten * qtdTotenEquip;
            }
            
            // Custo total mensal operacional
            const custoOperacional = custoInternet + custoEnergia + custoManutencao + custoAnalitico + custoLocacaoMensal;
            const custoRoyalties = receitaMensal * royalties;
            const custoImpostos = receitaMensal * impostos;
            const custoMensal = custoOperacional + custoRoyalties + custoImpostos;
            
            // Implantação (Mês 0)
            const custoInstalacao = parseFloat(document.getElementById('custoInstalacao').value) || 0;
            const custoFrete = parseFloat(document.getElementById('custoFrete').value) || 0;
            const margemEquip = (parseFloat(document.getElementById('margemEquipamentos').value) || 0) / 100;
            
            let custoEquipamentos = 0;
            if (lprModelo === 'compra') {
                const valorCompraLPR = parseFloat(document.getElementById('valorCompraLPR').value) || 0;
                const qtdLPR = parseInt(document.getElementById('qtdLPR').value) || 0;
                custoEquipamentos += valorCompraLPR * qtdLPR;
            }
            if (pmiModelo === 'compra') {
                const valorCompraPMI = parseFloat(document.getElementById('valorCompraPMI').value) || 0;
                const qtdPMICam = parseInt(document.getElementById('qtdPMICam').value) || 0;
                custoEquipamentos += valorCompraPMI * qtdPMICam;
            }
            if (totenModelo === 'compra') {
                const valorCompraT = parseFloat(document.getElementById('valorCompraT').value) || 0;
                const qtdTotenEquip = parseInt(document.getElementById('qtdTotenEquip').value) || 0;
                custoEquipamentos += valorCompraT * qtdTotenEquip;
            }
            
            const receitaEquipamentos = custoEquipamentos * (1 + margemEquip);
            const receitaImplantacao = receitaEquipamentos + custoInstalacao + custoFrete;
            const despesaImplantacao = custoEquipamentos + custoInstalacao + custoFrete;
            
            // Atualizar resumo de implantação
            document.getElementById('resumoImplantacao').innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div>
                        <strong>Custo Equipamentos:</strong><br>
                        ${formatarMoeda(custoEquipamentos)}
                    </div>
                    <div>
                        <strong>Receita Equipamentos (com margem):</strong><br>
                        ${formatarMoeda(receitaEquipamentos)}
                    </div>
                    <div>
                        <strong>Instalação:</strong><br>
                        ${formatarMoeda(custoInstalacao)}
                    </div>
                    <div>
                        <strong>Frete:</strong><br>
                        ${formatarMoeda(custoFrete)}
                    </div>
                    <div style="grid-column: 1 / -1; background: #e9ecef; padding: 15px; border-radius: 8px; margin-top: 10px;">
                        <strong>Receita Total de Implantação:</strong><br>
                        <span style="font-size: 1.5em; color: #667eea;">${formatarMoeda(receitaImplantacao)}</span>
                    </div>
                </div>
            `;
            
            // Simulação de 13 meses (0 a 12)
            const simulacao = [];
            let saldoAcumulado = 0;
            let mesEquilibrio = null;
            
            for (let mes = 0; mes <= 12; mes++) {
                let receitaMes = mes === 0 ? receitaImplantacao : receitaMensal;
                let despesaMes = mes === 0 ? despesaImplantacao : custoMensal;
                let saldoMes = receitaMes - despesaMes;
                saldoAcumulado += saldoMes;
                
                if (mesEquilibrio === null && saldoAcumulado >= 0 && mes > 0) {
                    mesEquilibrio = mes;
                }
                
                simulacao.push({
                    mes: mes,
                    receita: receitaMes,
                    despesa: despesaMes,
                    saldo: saldoMes,
                    saldoAcumulado: saldoAcumulado,
                    // Detalhamento das despesas
                    custoInternet: mes === 0 ? 0 : custoInternet,
                    custoEnergia: mes === 0 ? 0 : custoEnergia,
                    custoManutencao: mes === 0 ? 0 : custoManutencao,
                    custoAnalitico: mes === 0 ? 0 : custoAnalitico,
                    custoLocacao: mes === 0 ? 0 : custoLocacaoMensal,
                    custoRoyalties: mes === 0 ? 0 : custoRoyalties,
                    custoImpostos: mes === 0 ? 0 : custoImpostos,
                    custoEquipamentos: mes === 0 ? custoEquipamentos : 0,
                    custoInstalacao: mes === 0 ? custoInstalacao : 0,
                    custoFrete: mes === 0 ? custoFrete : 0
                });
            }
            
            // Atualizar dashboard
            document.getElementById('contratoAnual').textContent = formatarMoeda(receitaMensal * 12);
            document.getElementById('receitaMensal').textContent = formatarMoeda(receitaMensal);
            document.getElementById('custoMensal').textContent = formatarMoeda(custoMensal);
            
            const rentabilidade = receitaMensal > 0 ? ((receitaMensal - custoMensal) / receitaMensal * 100) : 0;
            document.getElementById('rentabilidade').textContent = rentabilidade.toFixed(1) + '%';
            document.getElementById('rentabilidade').className = 'value ' + (rentabilidade >= 0 ? 'positive' : 'negative');
            
            document.getElementById('mesEquilibrio').textContent = mesEquilibrio !== null ? `Mês ${mesEquilibrio}` : 'Não atingido';
            document.getElementById('saldoFinal').textContent = formatarMoeda(saldoAcumulado);
            document.getElementById('saldoFinal').className = 'value ' + (saldoAcumulado >= 0 ? 'positive' : 'negative');
            
            // Gerar tabelas
            gerarTabelaDespesas(simulacao);
            gerarTabelaReceitas(simulacao);
            gerarTabelaSaldo(simulacao);
            
            // Salvar dados
            salvarDados();
        }

        // Gerar tabela de despesas (formato horizontal)
        function gerarTabelaDespesas(simulacao) {
            const container = document.getElementById('tabelaDespesas');
            
            // Definir linhas de despesas
            const linhasDespesas = [
                { label: 'Equipamentos', key: 'custoEquipamentos' },
                { label: 'Instalação', key: 'custoInstalacao' },
                { label: 'Frete', key: 'custoFrete' },
                { label: 'Internet', key: 'custoInternet' },
                { label: 'Energia', key: 'custoEnergia' },
                { label: 'Manutenção', key: 'custoManutencao' },
                { label: 'Analíticos', key: 'custoAnalitico' },
                { label: 'Locação Equipamentos', key: 'custoLocacao' },
                { label: 'Royalties', key: 'custoRoyalties' },
                { label: 'Impostos', key: 'custoImpostos' }
            ];
            
            let html = '<div class="table-horizontal-wrapper"><table class="table-horizontal">';
            
            // Cabeçalho
            html += '<thead><tr><th>Item/Mês</th>';
            for (let i = 0; i <= 12; i++) {
                html += `<th>${i}</th>`;
            }
            html += '</tr></thead><tbody>';
            
            // Linhas de despesas
            linhasDespesas.forEach(linha => {
                html += `<tr><td>${linha.label}</td>`;
                simulacao.forEach(mes => {
                    const valor = mes[linha.key] || 0;
                    html += `<td>${formatarMoeda(valor)}</td>`;
                });
                html += '</tr>';
            });
            
            // Linha de total
            html += '<tr class="total-row"><td>Despesa Total</td>';
            simulacao.forEach(mes => {
                html += `<td>${formatarMoeda(mes.despesa)}</td>`;
            });
            html += '</tr>';
            
            html += '</tbody></table></div>';
            container.innerHTML = html;
        }

        // Gerar tabela de receitas (formato horizontal)
        function gerarTabelaReceitas(simulacao) {
            const container = document.getElementById('tabelaReceitas');
            const modelo = document.querySelector('input[name="modelo"]:checked').value;
            
            let html = '<div class="table-horizontal-wrapper"><table class="table-horizontal">';
            
            // Cabeçalho
            html += '<thead><tr><th>Item/Mês</th>';
            for (let i = 0; i <= 12; i++) {
                html += `<th>${i}</th>`;
            }
            html += '</tr></thead><tbody>';
            
            // Receita do mês 0 (implantação)
            const custoEquipamentos = simulacao[0].custoEquipamentos;
            const margemEquip = (parseFloat(document.getElementById('margemEquipamentos').value) || 0) / 100;
            const receitaEquipamentos = custoEquipamentos * (1 + margemEquip);
            const custoInstalacao = simulacao[0].custoInstalacao;
            const custoFrete = simulacao[0].custoFrete;
            
            html += '<tr><td>Equipamentos</td>';
            html += `<td>${formatarMoeda(receitaEquipamentos)}</td>`;
            for (let i = 1; i <= 12; i++) {
                html += '<td>R$ 0,00</td>';
            }
            html += '</tr>';
            
            html += '<tr><td>Instalação</td>';
            html += `<td>${formatarMoeda(custoInstalacao)}</td>`;
            for (let i = 1; i <= 12; i++) {
                html += '<td>R$ 0,00</td>';
            }
            html += '</tr>';
            
            html += '<tr><td>Frete</td>';
            html += `<td>${formatarMoeda(custoFrete)}</td>`;
            for (let i = 1; i <= 12; i++) {
                html += '<td>R$ 0,00</td>';
            }
            html += '</tr>';
            
            // Receitas mensais
            if (modelo === 'usuario') {
                html += '<tr><td>Mensalidade</td>';
                html += '<td>R$ 0,00</td>';
                for (let i = 1; i <= 12; i++) {
                    html += `<td>${formatarMoeda(simulacao[i].receita)}</td>`;
                }
                html += '</tr>';
            } else {
                // Detalhar produtos
                const produtos = [
                    { label: 'Armazenamento', preco: 'precoArmazenamento', qtd: 'qtdArmazenamento' },
                    { label: 'PMI', preco: 'precoPMI', qtd: 'qtdPMI' },
                    { label: 'OCR', preco: 'precoOCR', qtd: 'qtdOCR' },
                    { label: 'Toten', preco: 'precoToten', qtd: 'qtdToten' },
                    { label: 'Detecções', preco: 'precoDeteccoes', qtd: 'qtdDeteccoes' }
                ];
                
                produtos.forEach(prod => {
                    const preco = parseFloat(document.getElementById(prod.preco).value) || 0;
                    const qtd = parseInt(document.getElementById(prod.qtd).value) || 0;
                    const valor = preco * qtd;
                    
                    html += `<tr><td>${prod.label}</td>`;
                    html += '<td>R$ 0,00</td>';
                    for (let i = 1; i <= 12; i++) {
                        html += `<td>${formatarMoeda(valor)}</td>`;
                    }
                    html += '</tr>';
                });
            }
            
            // Linha de total
            html += '<tr class="total-row"><td>Receita Total</td>';
            simulacao.forEach(mes => {
                html += `<td>${formatarMoeda(mes.receita)}</td>`;
            });
            html += '</tr>';
            
            html += '</tbody></table></div>';
            container.innerHTML = html;
        }

        // Gerar tabela de saldo (formato horizontal)
        function gerarTabelaSaldo(simulacao) {
            const container = document.getElementById('tabelaSaldo');
            
            let html = '<div class="table-horizontal-wrapper"><table class="table-horizontal">';
            
            // Cabeçalho
            html += '<thead><tr><th>Item/Mês</th>';
            for (let i = 0; i <= 12; i++) {
                html += `<th>${i}</th>`;
            }
            html += '</tr></thead><tbody>';
            
            // Saldo do mês
            html += '<tr><td>Saldo do Mês</td>';
            simulacao.forEach(mes => {
                const classe = mes.saldo >= 0 ? 'positive' : 'negative';
                html += `<td class="${classe}">${formatarMoeda(mes.saldo)}</td>`;
            });
            html += '</tr>';
            
            // Saldo acumulado
            html += '<tr><td>Saldo Acumulado</td>';
            simulacao.forEach(mes => {
                const classe = mes.saldoAcumulado >= 0 ? 'positive' : 'negative';
                html += `<td class="${classe}">${formatarMoeda(mes.saldoAcumulado)}</td>`;
            });
            html += '</tr>';
            
            html += '</tbody></table></div>';
            container.innerHTML = html;
        }

        // Formatar moeda
        function formatarMoeda(valor) {
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            }).format(valor);
        }

        // Salvar dados no localStorage
        function salvarDados() {
            const dados = {
                // Modelo
                modelo: document.querySelector('input[name="modelo"]:checked').value,
                valorUsuario: document.getElementById('valorUsuario').value,
                qtdUsuarios: document.getElementById('qtdUsuarios').value,
                
                // Produtos
                precoArmazenamento: document.getElementById('precoArmazenamento').value,
                qtdArmazenamento: document.getElementById('qtdArmazenamento').value,
                precoPMI: document.getElementById('precoPMI').value,
                qtdPMI: document.getElementById('qtdPMI').value,
                precoOCR: document.getElementById('precoOCR').value,
                qtdOCR: document.getElementById('qtdOCR').value,
                precoToten: document.getElementById('precoToten').value,
                qtdToten: document.getElementById('qtdToten').value,
                precoDeteccoes: document.getElementById('precoDeteccoes').value,
                qtdDeteccoes: document.getElementById('qtdDeteccoes').value,
                
                // Custos Fixos
                custoInternet: document.getElementById('custoInternet').value,
                custoEnergia: document.getElementById('custoEnergia').value,
                royalties: document.getElementById('royalties').value,
                impostos: document.getElementById('impostos').value,
                custoManutencao: document.getElementById('custoManutencao').value,
                custoOCR: document.getElementById('custoOCR').value,
                custoDeteccoes: document.getElementById('custoDeteccoes').value,
                
                // Equipamentos
                lprModelo: document.querySelector('input[name="lprModelo"]:checked').value,
                qtdLPR: document.getElementById('qtdLPR').value,
                valorCompraLPR: document.getElementById('valorCompraLPR').value,
                valorLocacaoLPR: document.getElementById('valorLocacaoLPR').value,
                pmiModelo: document.querySelector('input[name="pmiModelo"]:checked').value,
                qtdPMICam: document.getElementById('qtdPMICam').value,
                valorCompraPMI: document.getElementById('valorCompraPMI').value,
                valorLocacaoPMI: document.getElementById('valorLocacaoPMI').value,
                totenModelo: document.querySelector('input[name="totenModelo"]:checked').value,
                qtdTotenEquip: document.getElementById('qtdTotenEquip').value,
                valorCompraT: document.getElementById('valorCompraT').value,
                valorLocacaoToten: document.getElementById('valorLocacaoToten').value,
                
                // Implantação
                custoInstalacao: document.getElementById('custoInstalacao').value,
